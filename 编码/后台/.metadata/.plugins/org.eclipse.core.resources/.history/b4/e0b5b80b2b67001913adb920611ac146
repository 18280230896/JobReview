var ctid = $("#ctid").val();
var task;
var classTask;
var id = $("#id").val();
getTaskInfo();
showClassTask();

var subjectIndex = 0;
//上一题点击事件
$(".prevSubject").click(function(){
	subjectIndex --;
	var width = $(".content")[0].offsetWidth;
	$(".content-list").animate({"left":-subjectIndex*width},400);
	if(subjectIndex == 0) $(".prevSubject").prop("disabled","disabled");
	$(".nextSubject").prop("disabled","");
	getAndShowCode(task.subjects[subjectIndex].id);
	$(".console").empty();
});


//下一题点击事件
$(".nextSubject").click(function(){
	subjectIndex ++;
	var width = $(".content")[0].offsetWidth;
	$(".content-list").animate({"left":-subjectIndex*width},400);
	if(subjectIndex == task.subjects.length - 1) $(".nextSubject").prop("disabled","disabled");
	$(".prevSubject").prop("disabled","");
	getAndShowCode(task.subjects[subjectIndex].id);
	$(".console").empty();
});

//input内容改变事件
$("#scoreInput").on("input propertychange",function(){
	console.log(1);
	var value = $(this).val();
	var regexp = nwe RegExp("/^[1-9][0-9]{0,2}$?");
	if(!regexp.test(value)){
		$(this).parent().parent().addClass("has-error").removeClass("has-success");
		$(this).parent().next().hide().text("请输入正确的分数！").slideDown(250);
	}
});

function getTaskInfo(){
	$.ajax({
		url:"teacherGetClassTask.action",
		type:"post",
		data:{"ctid":ctid},
		dataType:"json",
		async:false,
		success:function(result){
			if(result.status == 1){
				task = result.task;
				classTask = result.classTask;
			}
		}
	});
}

function showClassTask(){
	var length = task.subjects.length;
	if(length == 0){
		prohibit();
		return;
	}
	$(".content-list").css("width",length+"00%");
	for(var i=0;i<length;i++){
		var newLi = $("<li class='content'></li>");
		var newSubject = $("<div class='subject'><h4>"+(i+1)+"、"+task.subjects[i].name+"</h4></div>")
		newLi.append(newSubject);
		if(classTask.type === 2){
			//显示分工信息
			var division = getDivision(task.subjects[i].id);
			var newfengong = $("<div class='fengong'></div>");
			var newp = $("<p></p>");
			if(division.length == 0) newp.append($("<span>该题目还没有设置负责人哦！</span>"));
			else{
				var text = "该题目负责人：";
				for(var j=0;j<division.length;j++){
					text += division[j].student.name;
					if(j != division.length - 1) text += "、";
				}
				newp.append("<span>"+text+"</span>");
			}
			newfengong.append(newp);
			newLi.append(newfengong);
		}
		$(".content-list").append(newLi);
		$(".content").css("width",100/length+"%");
		$(".prevSubject").prop("disabled","disabled");
		if(length == 1) $(".nextSubject").prop("disabled","disabled");
	}
	getAndShowCode(task.subjects[0].id);
}

function getDivision(subjectId){
	var division;
	$.ajax({
		url:"teacherGetDivision.action",
		type:"post",
		data:{"gid":id,"sid":subjectId},
		dataType:"json",
		async:false,
		success:function(result){
			division = result.division
		}
	});
	return division;
}

function getAndShowCode(subjectId){
	$.ajax({
		url:"teacherGetWork.action",
		type:"post",
		data:{"id":id,"ctid":ctid,"subjectId":subjectId},
		dataType:"json",
		success:function(result){
			if(result.status == 1){
				javaEditor.setValue(result.code);
			}else{
				javaEditor.setValue("该题目还没有提交！");
			}
		}
	});
}
