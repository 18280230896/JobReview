var task;
var taskId = $("#taskId").val();
//初始任务基本信息
taskInfoInit();
//修改任务信息输入验证
$("#updateModal .form-control").on("input propertychange",function(){
	var index = $(this).parent().index();
	var value = $(this).val();
	if(index == 0){
		//任务名称验证
		if(value.length < 2 || value.length > 20){
			$("#updateModal .help-block").eq(index).hide().text("必须输入2-20个字符！").slideDown(200);
			$("#updateModal .form-group").eq(index).removeClass("has-success").addClass("has-error");
		}else{
			$("#updateModal .help-block").eq(index).slideUp(200);
			$("#updateModal .form-group").eq(index).removeClass("has-error").addClass("has-success");
		}
	}else if(index == 1){
		//任务类型验证
		if(value.length <2 || value.length > 10){
			$("#updateModal .help-block").eq(index).hide().text("必须输入2-10个字符！").slideDown(200);
			$("#updateModal .form-group").eq(index).removeClass("has-success").addClass("has-error");
		}else{
			$("#updateModal .help-block").eq(index).slideUp(200);
			$("#updateModal .form-group").eq(index).removeClass("has-error").addClass("has-success");
		}
	}else if(index == 2){
		//任务连接输入验证
		if(value.length < 5 || value.length > 50){
			$("#updateModal .help-block").eq(index).hide().text("必须输入5-50个字符！").slideDown(200);
			$("#updateModal .form-group").eq(index).removeClass("has-success").addClass("has-error");
		}else{
			$("#updateModal .help-block").eq(index).slideUp(200);
			$("#updateModal .form-group").eq(index).removeClass("has-error").addClass("has-success");
		}
	}else if(index == 3){
		//任务简介验证
		if(value.length < 1 || value.length > 100){
			$("#updateModal .help-block").eq(index).hide().text("必须输入1-100个字符！").slideDown(200);
			$("#updateModal .form-group").eq(index).removeClass("has-success").addClass("has-error");
		}else{
			$("#updateModal .help-block").eq(index).slideUp(200);
			$("#updateModal .form-group").eq(index).removeClass("has-error").addClass("has-success");
		}
	}else if(index == 4){
		//任务模块名称验证
		if(value.length < 2 || value.length > 10){
			$("#updateModal .help-block").eq(index).hide().text("必须输入2-10个字符！").slideDown(200);
			$("#updateModal .form-group").eq(index).removeClass("has-success").addClass("has-error");
		}else{
			$("#updateModal .help-block").eq(index).slideUp(200);
			$("#updateModal .form-group").eq(index).removeClass("has-error").addClass("has-success");
		}
	}
});

//修改任务信息
$("#updateModal .btn").eq(1).click(function(){
	if($(this).prev().prev().val() == 1){
		//修改任务信息
		var index = $(this).prev().val();
		if(!$("#updateModal .form-group").eq(index).hasClass("has-success")){
			$("#updateModal .form-control").eq(index).focus();
			return;
		}
		var key;
		var value = $("#updateModal .form-control").eq(index).val();
		if (index == 0) key="taskName";
		else if (index == 1) key="taskType";
		else if (index == 2) key="taskLink";
		else if (index == 3) key="taskDescribe";
		if(updaTaskInfo(key,value) == 1){
			//弹窗消失
			$("#updateModal").modal("hide");
			//刷新界面
			taskInfoInit();
			//显示提示
			tips("success","修改成功！");
			//重置input
			$("#updateModal .form-group").removeClass("has-success");
		}
	}else if($(this).prev().prev().val() == 2){
		//修改模块
		var id = $(this).prev().val();
		if(!$("#updateModal .form-group").eq(4).hasClass("has-success")){
			$("#updateModal .form-control").eq(4).focus();
			return;
		}
		var name = $("#updateModal .form-control").eq(4).val();
		if(updaModule(id,name) == 1){
			//弹窗消失
			$("#updateModal").modal("hide");
			//刷新界面
			taskInfoInit();
			//显示提示
			tips("success","修改成功！");
			//重置input
			$("#updateModal .form-group").removeClass("has-success");
		}
	}
});

//添加任务模块输入验证
$("#addModuleModal form").on("input propertychange",function(event){
	var value = $(event.target).val();
	if(value.length < 2 || value.length > 10){
		$(event.target).parent().parent().removeClass("has-success").addClass("has-error");
		$(event.target).parent().next().hide().text("必须输入2-10个字符！").slideDown(200);
	}else{
		$(event.target).parent().parent().removeClass("has-error").addClass("has-success");
		$(event.target).parent().next().slideUp(200);
	}
});
//点击添加模块按钮
$("#addModuleModal .addBtn").click(function(){
	for(var i=0;i<$("#addModuleModal .form-group").length;i++){
		if(!$("#addModuleModal .form-group").eq(i).hasClass("has-success")){
			$("#addModuleModal .form-control").eq(i).focus();
			return;
		}
	}
	var inputs = $("#addModuleModal .form-control");
	var count = 0;
	for(var i=0;i<inputs.length;i++){
		if(addModule(taskId,$(inputs[i]).val()) == 1) count++;
	}
	if(count == inputs.length){
		//弹窗消失
		$("#addModuleModal").modal("hide");
		//刷新数据
		taskInfoInit();
		//显示提示
		tips("success","添加成功！");
		//重置输入框
		$(".reset").click();
		$("#addModuleModal .form-group:gt(0)").remove();
		$("#addModuleModal .form-group").removeClass("has-success");
	}
});

//点击删除模块
$("#dleModal .btn").eq(1).click(function(){
	if($("#dleModal input").eq(0).val() == 1){
		//删除模块
		var moduleId = $("#dleModal input").eq(1).val();
		if(delModule(moduleId) == 1){
			//弹窗消失
			$("#dleModal").modal("hide");
			//刷新数据
			taskInfoInit();
			//显示提示
			tips("success","删除成功！");
		}
	}else if($("#dleModal input").eq(0).val() == 2){
		//删除附件
		var taskFileId = $("#dleModal input").eq(1).val();
		if(delTaskFile(taskFileId) == 1){
			//弹窗消失
			$("#dleModal").modal("hide");
			//刷新数据
			taskInfoInit();
			//显示提示
			tips("success","删除成功！");
		}
	}
		
});
//添加任务附件
$("#addTaskFileModal .btn").eq(2).click(function(){
	if($("#addTaskFileModal .file-group").length == 0 || $("#addTaskFileModal .file-group input:eq(0)").val() == ""){
		$("#addTaskFileModal .text-danger").text("请至少选择一个附件！");
	}else{
		$("#addTaskFileModal .text-danger").text("");
		var formData = new FormData($("#addTaskFileModal form")[0]);
		if(addTaskFile(formData) == 1){
			//弹窗消失
			$("#addTaskFileModal").modal("hide");
			//刷新数据
			taskInfoInit();
			//显示提示
			tips("success","添加成功！");
			//重置input
			$("#addTaskFileModal .file-group").remove();
		}
	}
});

//添加模块
function addModule(taskId,moduleName){
	var msg;
	$.ajax({
		url:"teacherAddModule.action",
		type:"post",
		data:{"taskId":taskId,"moduleName":moduleName},
		dataType:"json",
		async:false,
		success:function(result){
			msg = result.msg;
		}
	});
	return msg
}

//删除模块
function delModule(moduleId){
	var msg;
	$.ajax({
		url:"teacherDleModule.action",
		type:"post",
		data:{"moduleId":moduleId},
		dataType:"json",
		async:false,
		success:function(result){
			msg = result.msg;
		}
	});
	return msg
}

//添加任务附件
function addTaskFile(formData){
	var msg;
	$.ajax({
		url:"teacherAddFile.action",
		type:"post",
		data:formData,
		dataType:"json",
		async:false,
		cache: false,  
        contentType: false,  
        processData: false,
		success:function(result){
			msg = result.msg;
		}
	});
	return msg
}

//删除任务附件
function delTaskFile(taskFileId){
	var msg;
	$.ajax({
		url:"teacherDelFile.action",
		type:"post",
		data:{"taskFileId":taskFileId},
		dataType:"json",
		async:false,
		success:function(result){
			msg = result.msg;
		}
	});
	return msg
}

//修改任务基本信息
function updaTaskInfo(key,value){
	var msg;
	var data = "taskId="+taskId+"&"+key+"="+value;
	$.ajax({
		url:"teacherUpdateTask.action",
		type:"post",
		data:data,
		dataType:"json",
		async:false,
		success:function(result){
			msg = result.msg;
		}
	});
	return msg;
}

//修改模块信息
function updaModule(id,name){
	var msg;
	$.ajax({
		url:"teacherUpdateModule.action",
		type:"post",
		data:{"moduleId":id,"moduleName":name},
		dataType:"json",
		async:false,
		success:function(result){
			msg = result.msg;
		}
	});
	return msg;
}

//初始任务基本信息
function taskInfoInit(){
	//获取数据
	$.ajax({
		url:"teacherGetTaskInfo.action",
		type:"post",
		data:{"taskId":taskId},
		dataType:"json",
		success:function(result){
			task = result.task;
			//将任务信息展示到界面
			//基本信息
			$("#taskInfo li:eq(0) span:eq(1)").text(task.name);
			if(task.type === 1) $("#taskInfo li:eq(1) span:eq(1)").text("Java 任务");
			else $("#taskInfo li:eq(1) span:eq(1)").text("Oracle 任务");
			
			//模块列表
			//先清空，在生成
			$("#moduleList .ul-info").empty();
			for(var i=0;i<task.subjects.length;i++){
				if(task.subjects[i].id == null) continue;
				var newli = $("<li>"+
							"<input type='hidden' value='"+task.subjects[i].id+"' />"+
							"<span class='subjects'>"+(i+1)+"、"+task.subjects[i].name+"</span>"+
							" <span class='glyphicon glyphicon-pencil option update'></span>"+
							" <span class='glyphicon glyphicon-remove option delete'></span>"+
						"</li>")
				$("#moduleList .ul-info").append(newli);
			}
			if(task.subjects.length == 0 || task.subjects[0].id == null){
				var newli = $("<li>"+
						"<span>还没有题目哦!</span>"+
					"</li>")
			$("#moduleList .ul-info").append(newli);
			}
			
			//附件列表
			$("#fileList .ul-info").empty();
			for(var i=0;i<task.taskFiles.length;i++){
				var newli = $("<li>"+
							"<input type='hidden' value='"+task.taskFiles[i].taskFileId+"'>"+
							"<a href='teacherDownload.action?id="+task.taskFiles[i].taskFileId+"'><span>"+task.taskFiles[i].taskFileName+"</span></a>"+
							" <span class='glyphicon glyphicon-download-alt option download'></span>"+
							" <span class='glyphicon glyphicon-remove option delete'></span>"+
						"</li>")
				$("#fileList .ul-info").append(newli);
			}
			if(task.taskFiles.length == 0){
				var newli = $("<li>"+
						"<span>还没有任务附件！</span>"+
					"</li>")
			$("#fileList .ul-info").append(newli);
			}
		}
	});
	
}